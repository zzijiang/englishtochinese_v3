<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary Challenge</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>Vocabulary Challenge</h1>

        <!-- è¿›åº¦æ¡ -->
        <div class="progress-bar">
            <div class="progress-fill" id="progress-bar" style="width: 0%;"></div>
        </div>

        <h2 id="question-number">ç¬¬ 1 é¢˜</h2>
        <p class="word" id="question-text">Loading...</p>

        <div id="options-container" class="options"></div>

        <p id="feedback" class="hidden"></p>
    </div>

    <script>
        let selectedAnswer = "";
        let isProcessingAnswer = false;  // æ·»åŠ æ ‡å¿—ä½é˜²æ­¢é‡å¤æäº¤

        function updateQuestion(data) {
            // æ¸…é™¤åé¦ˆä¿¡æ¯
            const feedback = document.getElementById("feedback");
            feedback.innerHTML = "";
            feedback.classList.add("hidden");

            document.getElementById("question-number").innerText = `ç¬¬ ${data.question_number} é¢˜`;
            document.getElementById("question-text").innerText = data.english;

            // æ›´æ–°é€‰é¡¹
            let optionsHTML = "";
            data.options.forEach(option => {
                optionsHTML += `<button class="option-btn" onclick="submitAnswer(this)" data-answer="${option}">${option}</button>`;
            });
            document.getElementById("options-container").innerHTML = optionsHTML;

            // æ›´æ–°è¿›åº¦æ¡
            document.getElementById("progress-bar").style.width = data.progress + "%";

            // å¯ç”¨æ‰€æœ‰æŒ‰é’®
            enableButtons(true);
            
            // é‡ç½®å¤„ç†æ ‡å¿—
            isProcessingAnswer = false;
        }

        function loadNextQuestion(firstLoad = false) {
            document.getElementById("feedback").classList.add("hidden");

            fetch("/next", {
                method: "GET",
                headers: { "Content-Type": "application/json" }
            })
            .then(response => response.json())
            .then(data => {
                if (data.finished) {
                    window.location.href = data.redirect_url;
                    return;
                }
                updateQuestion(data);
            });
        }

        function enableButtons(enable) {
            const buttons = document.querySelectorAll('.option-btn');
            buttons.forEach(button => {
                button.disabled = !enable;
            });
        }

        async function submitAnswer(button) {
            if (isProcessingAnswer) return;  // å¦‚æœæ­£åœ¨å¤„ç†ç­”æ¡ˆï¼Œç›´æ¥è¿”å›
            isProcessingAnswer = true;  // è®¾ç½®å¤„ç†æ ‡å¿—

            // ç¦ç”¨æ‰€æœ‰æŒ‰é’®
            enableButtons(false);
            
            let userAnswer = button.getAttribute("data-answer");

            try {
                const response = await fetch("/next", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ answer: userAnswer })
                });
                
                const data = await response.json();
                
                if (data.finished) {
                    window.location.href = data.redirect_url;
                    return;
                }

                // æ˜¾ç¤ºåé¦ˆ
                let feedback = document.getElementById("feedback");
                if (data.is_correct) {
                    feedback.innerHTML = `âœ… æ­£ç¡®ï¼ <span class="correct-emoji">ğŸ‰</span>`;
                    feedback.style.color = "green";
                } else {
                    feedback.innerHTML = `âŒ <span style="color: red">é”™è¯¯ï¼</span><span class="black-text"> æ­£ç¡®ç­”æ¡ˆï¼š</span> <span class="green-text">${data.correct}</span>`;
                }
                feedback.classList.remove("hidden");

                // ç­‰å¾…æ˜¾ç¤ºåé¦ˆåæ›´æ–°é—®é¢˜
                setTimeout(() => {
                    updateQuestion(data);
                }, 1500);
            } catch (error) {
                console.error("Error submitting answer:", error);
                isProcessingAnswer = false;  // å‘ç”Ÿé”™è¯¯æ—¶é‡ç½®å¤„ç†æ ‡å¿—
                enableButtons(true);  // é‡æ–°å¯ç”¨æŒ‰é’®
            }
        }

        // é¡µé¢é¦–æ¬¡åŠ è½½æ—¶è·å–ç¬¬ä¸€é¢˜
        document.addEventListener("DOMContentLoaded", function() {
            loadNextQuestion(true);
        });
    </script>
</body>
</html>